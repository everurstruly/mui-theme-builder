#!/usr/bin/env node
/*
  generate-mui-theme-completions.cjs

  Generates a lightweight completions file from MUI's exported ThemeOptions type.

  Usage (after installing dev deps):
    pnpm add -D ts-json-schema-generator
    pnpm run generate:mui-completions

  The script attempts to read the type `ThemeOptions` from
  `node_modules/@mui/material/styles/index.d.ts` and will extract top-level
  property names to produce a completions file at
  src/Editor/PropertiesPanel/CodeEditor/muiThemeCompletions.ts

  Note: This is a pragmatic build-time approach. It won't produce nested
  completions or perfect type-aware suggestions, but it saves you from
  maintaining a hand-crafted list.
*/

const fs = require('fs');
const path = require('path');

function fatal(msg) {
  console.error(msg);
  process.exit(1);
}

async function run() {
  const outFile = path.resolve(__dirname, '..', 'src', 'Editor', 'PropertiesPanel', 'CodeEditor', 'muiThemeCompletions.ts');
  const muiDecl = path.resolve('node_modules', '@mui', 'material', 'styles', 'index.d.ts');

  if (!fs.existsSync(muiDecl)) {
    fatal(`Cannot find MUI declaration file at ${muiDecl}. Make sure @mui/material is installed.`);
  }

  // Try generating from TypeScript types first. If that fails (complex MUI types),
  // fall back to a runtime extraction using createTheme() which returns the
  // resolved theme object with top-level keys.
  let entries = [];

  try {
    const { createGenerator } = require('ts-json-schema-generator');
    const generator = createGenerator({
      path: muiDecl,
      tsconfig: path.resolve('tsconfig.json'),
      type: 'ThemeOptions',
      topRef: true,
      skipTypeCheck: true,
    });

    const schema = generator.createSchema('ThemeOptions');
    const defName = Object.keys(schema.definitions || {})[0];
    const properties = (schema.definitions && schema.definitions[defName] && schema.definitions[defName].properties) || schema.properties || {};
    const items = Object.keys(properties).sort();
    entries = items.map((k) => `  { label: ${JSON.stringify(k)}, type: "keyword", info: ${JSON.stringify((properties[k] && properties[k].description) || '')} }`);
  } catch (err) {
    console.warn('ts-json-schema-generator failed or is not available â€” falling back to runtime createTheme() extraction. Error:', err && err.message);

    try {
      // runtime fallback: use createTheme to get resolved theme keys
      const { createTheme } = require('@mui/material/styles');
      const theme = createTheme();
      const items = Object.keys(theme).sort();
      entries = items.map((k) => `  { label: ${JSON.stringify(k)}, type: "keyword", info: "" }`);
    } catch (runtimeErr) {
      fatal(`Runtime fallback failed: ${runtimeErr && runtimeErr.message}`);
    }
  }

  const content = `// THIS FILE IS AUTO-GENERATED by scripts/generate-mui-theme-completions.cjs\n// Run: pnpm add -D ts-json-schema-generator && pnpm run generate:mui-completions\n\nexport const muiThemeCompletions = [\n${entries.join(',\n')}\n];\n`;

  fs.mkdirSync(path.dirname(outFile), { recursive: true });
  fs.writeFileSync(outFile, content, 'utf8');
  console.log(`Wrote ${outFile} with ${entries.length} completion entries.`);
}

run().catch(err => {
  console.error(err);
  process.exit(1);
});
