#!/usr/bin/env node
/*
  generate-mui-theme-completions.js

  Generates a lightweight completions file from MUI's exported ThemeOptions type.

  Usage (after installing dev deps):
    pnpm add -D ts-json-schema-generator
    pnpm run generate:mui-completions

  The script attempts to read the type `ThemeOptions` from
  `node_modules/@mui/material/styles/index.d.ts` and will extract top-level
  property names to produce a completions file at
  src/Editor/PropertiesPanel/CodeEditor/muiThemeCompletions.ts

  Note: This is a pragmatic build-time approach. It won't produce nested
  completions or perfect type-aware suggestions, but it saves you from
  maintaining a hand-crafted list.
*/

const fs = require('fs');
const path = require('path');

function fatal(msg) {
  console.error(msg);
  process.exit(1);
}

async function run() {
  const outFile = path.resolve(__dirname, '..', 'src', 'Editor', 'PropertiesPanel', 'CodeEditor', 'muiThemeCompletions.ts');
  const muiDecl = path.resolve('node_modules', '@mui', 'material', 'styles', 'index.d.ts');

  if (!fs.existsSync(muiDecl)) {
    fatal(`Cannot find MUI declaration file at ${muiDecl}. Make sure @mui/material is installed.`);
  }

  let generator;
  try {
    // Lazy require so the script prints a helpful message when the package is missing
    const { createGenerator } = require('ts-json-schema-generator');
    generator = createGenerator({
      path: muiDecl,
      tsconfig: path.resolve('tsconfig.json'),
      type: 'ThemeOptions',
      topRef: true,
      skipTypeCheck: true,
    });
  } catch (err) {
    fatal("Missing dependency 'ts-json-schema-generator'. Install as a dev dependency: pnpm add -D ts-json-schema-generator");
  }

  const schema = generator.createSchema('ThemeOptions');

  // Prefer definition entry if available
  const defName = Object.keys(schema.definitions || {})[0];
  const properties = (schema.definitions && schema.definitions[defName] && schema.definitions[defName].properties) || schema.properties || {};

  const items = Object.keys(properties).sort();

  const entries = items.map((k) => {
    return `  { label: ${JSON.stringify(k)}, type: "keyword", info: ${JSON.stringify(properties[k] && properties[k].description || '')} }`;
  });

  const content = `// THIS FILE IS AUTO-GENERATED by scripts/generate-mui-theme-completions.js
// Run: pnpm add -D ts-json-schema-generator && pnpm run generate:mui-completions

export const muiThemeCompletions = [
${entries.join(',\n')}
];\n`;

  fs.mkdirSync(path.dirname(outFile), { recursive: true });
  fs.writeFileSync(outFile, content, 'utf8');
  console.log(`Wrote ${outFile} with ${entries.length} completion entries.`);
}

run().catch(err => {
  console.error(err);
  process.exit(1);
});
